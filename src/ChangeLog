2004-06-15  Kenichi Handa  <handa@m17n.org>

	* fontset.c (mfont__lookup_fontset): Fix selection of font groups
	by language.

	* draw.c (compose_glyph_string): If langauge is specified, call
	mface__for_chars even if a text is all latin.  Fix condition for
	setting non_ascii_found.

	* m17n-X.c (xft_find_metric): Fix setting of g->lbrearing.

	* m17n.h (minput_char_to_key): Delete extern.

	* m17n-gui.h (minput_event_to_key): Cancel previous change.

	* m17n-gui.c (null_device_open): Set several members of frame.

2004-06-14  Kenichi Handa  <handa@m17n.org>

	* m17n-gui.h (minput_event_to_key): Delete extern.

	* symbol.h (struct MSymbolStruct): Renamed from MSymbol.

	* m17n-core.h (MSymbol): Defined as "struct MSymbolStruct *".

	* Makefile.am (AM_CPPFLAGS): Refer to @M17NDIR@.

2004-06-08  Kenichi Handa  <handa@m17n.org>

	* character.c (mchar_put_prop): Don't increment the ref-count of
	record->table.

2004-06-04  Kenichi Handa  <handa@m17n.org>

	* m17n-core.c (mdebug__register_object): New function.
	(mdebug__unregister_object): Likewise.

	* internal.h (mdebug__register_object, mdebug__unregister_object):
	Extern them.
	(M17N_OBJECT_REGISTER, M17N_OBJECT_UNREGISTER): Call them
	respectively.

	* charset.c (mcharset__load_from_database): Don't call
	mconv__register_charset_coding here.

	* coding.c (find_coding): Get a real name from an element of
	coding_definition_list.
	(mconv__register_charset_coding): Set the real name at the top of
	param.
	(mcoding__load_from_database): Likewise.
	(mconv_list_codings): Adjusted for the above change.

2004-06-03  Kenichi Handa  <handa@m17n.org>

	* coding.c (find_coding): Find by canonicalized name.  Don't have
	to modify the element of coding_definition_list by
	mplist__from_plist.
	(mconv__define_coding_from_charset): Delete it.
	(mconv__register_charset_coding): Canonicalize sym.
	(mcoding__load_from_database): Register plist modified by
	mplist__from_plist.

	* coding.h (mconv__define_coding_from_charset): Don't extern it.

	* font-ft.c (ft_open): Fix setting of rfont->descent.

2004-06-02  Kenichi Handa  <handa@m17n.org>

	* font.c (enum xlfd_field_idx): Moved from m17n-X.c.
	(xlfd_parse_name): Merge split_font_name and xfont_parse_name.
	(xlfd_unparse_name): Renamed from xfont_build_name.
	(mfont__init): Initialized Mfontconfig.
	(mfont__free_realized): Unconditionally unref rfont->info.
	(mfont__select): Free `this' if it's not best.
	(mfont__open): Don't check frame->realized_font_list.
	(mfont__parse_name_into_font): New function.
	(Mfontconfig): New variable.
	(mfont_from_name): Call mfont_parse_name.
	(mfont_name): Call mfont_unparse_name.
	(mdebug_dump_font): Likewise.

	* font.h (struct MFontDriver): Delete members parse_name and
	build_name.
	(mfont__ft_parse_name, mfont__ft_unparse_name): Extern them.
	(mfont__parse_name_into_font): Extern it.

	* font-ft.c: Include "symbol.h".
	(close_ft): Unconditionally free filename and charmap_list of
	ft_into.
	(ft_open): Duplicate base->filename.  Increment ref-count of
	ft_info->charmap_list.  Free ft_info->charmap_list and
	ft_info->filename on error.
	(mfont__ft_parse_name, mfont__ft_unparse_name): New functions.

	* m17n-X.c (xfont_driver): Don't include xfont_parse_name and
	xfont_build_name.
	(enum xlfd_field_idx): Moved to font.c.
	(split_font_name, build_font_name): Likewise.
	(build_font_list): Call mfont__parse_name_info_font.
	(xfont_open): Call mfont__unparse_name.  Free name.
	(xfont_parse_name, xfont_build_name): Moved to font.c
	(xft_select): Prototype deleted.
	(device_open): Check HAVE_FREETYPE on using mfont__ft_driver.
	Call mfont_pase_name.

	* m17n-gui.c (free_frame): Unref frame->font_driver_list.
	(m17n_fini_win): Add check HAVE_FREETYPE on using null_interface.
	(mframe): Likewise.

	* m17n-gui.h (mfont_parse_name, mfont_unparse_name, Mfontconfig):
	Extern them.

	* Makefile.am (linkgui_LDADD): Add libm17n-X.la and libm17n-gd.la.

2004-06-01  Kenichi Handa  <handa@m17n.org>

	* fontset.c (mfontset_modify_entry): Pay attention to the case
	that fontset->font_spec_list is NULL.

2004-05-31  Kenichi Handa  <handa@m17n.org>

	* m17n-gui.c: Include <dlfcn.h> only when HAVE_DLFCN_H is defined.

	* input.c: Include <dlfcn.h> only when HAVE_DLFCN_H is defined.

	* font.c (mfont__select): Print score the a font for debugging.

	* Makefile.am (libm17n_la_LIBADD): Delete -ldl.

	* coding.c (reset_coding_sjis): Check kanji and kana instead of
	kanji_sym and kana_sym.

2004-05-28  Kenichi Handa  <handa@m17n.org>

	* Makefile.am (VINFO): New variable.
	(libm17n_core_la_LDFLAGS, libm17n_la_LDFLAGS)
	(libm17n_gd_la_LDFLAGS): Include ${VINFO}.

2004-05-27  Kenichi Handa  <handa@m17n.org>

	The following chanages are to make device dependent functions
	accessible only from MDeviceDriver structure, and to add GD and
	null device drivers.  Font drivers get also device dependent.

	* m17n.c (m17n_init): Increament shell_initialized.
	(m17n_fini): Decremented shell_initialized.

	* m17n-misc.h (enum MErrorCode): New element MERROR_GD.

	* m17n-gui.h (Mdevice, Mdisplay, Mscreen, Mdrawable, Mdepth)
	(Mwidget, Mcolormap, Mx): Extern them.

	* m17n-gui.c: Include <dlfcn.h> and "config.h".
	(free_frame): Call frame->driver->close instead of
	mwin__close_device.
	(DLOPEN_SHLIB_EXT): New macro.
	(MDeviceLibraryInterface): New type.
	(device_library_list): New variable.
	(register_device_library): New function.
	(null_device): New variable.
	(null_device_close, null_device_get_prop)
	(null_device_realize_face, null_device_free_realized_face): New
	function.
	(null_driver): New variable.
	(null_device_init, null_device_fini, null_device_open): New
	functions.
	(null_interface): New variable.
	(Mfreetype, Mdevice): Declare them.
	(m17n_init_win): Increment win_initialized.  Initialize Mx, Mgd,
	Mfreetype, Mdevice, Mdisplay, Mscreen, Mdrawable, Mdevice, and
	Mwin__Close_Device.  Register drivers for Mx and Mgd.
	(m17n_fini_win): Decremented win_initialized.  Call "fini"
	function of all opened devices.  Don't call mwin__fini.
	(Mdisplay, Mscreen, Mdrawable, Mdepth, Mwidget, Mcolormap):
	Declare them here.
	(mframe): Handle Mdevice key of PLIST.
	(mframe_get_prop): Call frame->device->get_prop instead of
	mwin__device_get_prop.

	* m17n-gd.c: New file.

	* m17n-core.h (M17NLIB_MAJOR_VERSION, M17NLIB_MINOR_VERSION)
	(M17NLIB_PATCH_LEVEL, M17NLIB_VERSION_NAME): Updated to 1.1.0.

	* m17n-core.c (m17n_init_core): Increate core_initialized.
	(m17n_fini_core): Decremented core_initialized.

	* m17n-X.h (Mdisplay, Mscreen, Mdrawable, Mdepth, Mwidget)
	(Mcolormap): Don't extern them here.

	* m17n-X.c (FRAME_DEVICE): New macro.
	(FRAME_DISPLAY, FRAME_SCREEN, FRAME_CMAP): Use FRAME_DEVICE.
	(free_display_info): Use MPLIST_DO.
	(free_device): Free rface->info.
	(xft_close): Delete it.
	(device_init): Renamed from mwin__init.
	(device_fini): Renamed from mwin__fini.
	(device_open): Renamed from mwin__open_device.
	(x_driver): New variable.
	(MXFontInfo): Delete member frame, add member display.
	(Mdisplay, Mscreen, Mdrawable, Mdepth, Mwidget, Mcolormap, Mxim):
	Don't declare them here.

	* internal-gui.h (MDeviceType): New enum.
	(MWDefice): Delete it.
	(struct MFrame): Change type of device to void *.  New members
	device_type, driver, font_driver_list.
	(M_CHECK_WRITABLE, M_CHECK_READABLE): New macros.
	(MDeviceDriver): New type.
	(Mx, Mgd, Mfreetype): Extern them.
	(mwin__XXX): Delete all of them.

	* input-gui.c (win_create_ic): Call frame->driver->XXX instead of
	mwin__XXX.
	(win_destroy_ic): Likewise.
	(adjust_window_and_draw): Likewise.
	(win_callback): Likewise.
	(Mxim): Declare it here.
	(minput_event_to_key): Call M_CHECK_READABLE.

	* fontset.c (mfont__lookup_fontset): Delete local variable
	font_group.

	* font.h (struct MFontDriver): Delete member close, add members
	parse_name and build_name.
	(mfont__driver_list): Delete extern.
	(mfont__close): Delete extern.

	* font.c (mfont__init): Don't set mfont__driver_list.
	(mfont__fini): Don't unref mfont__driver_list.
	(mfont__select): Try font drivers in frame->font_driver_list.  Set
	driver member of a realized font.
	(mfont__close): Delete it.
	(mfont_from_name, mfont_name, mdebug_dump_font): Call driver
	functions of the default frame.

	* font-ft.c (close_ft): Check ft_info->ft_face and work
	differently.
	(add_font_info): Allocate ft_info by M17N_OBJECT.
	(ft_close): Delete it.
	(mfont__ft_driver): Don't set ft_close.
	(ft_select): Increment ref-count of best_font.
	(ft_open): Decremented ref-count of base.  On error, call
	FT_Done_Face and free ft_info.
	(ft_find_metric): Always use XXX_MONO in load_flags.
	(ft_render): Fix setting of width.  Call
	frame->driver->draw_points instead of mwin__draw_points.
	(ft_to_prop): Don't set mfont__driver_list.
	(mfont__ft_fini): Just unref ft_info.

	* face.c (mface__init): Exchange foreground and background of
	mface__default.  Call mface_put_prop to set hline of
	mface_underline,
	(mface__realize): Call frame->driver->XXX instead of mwin__XXX.
	(mface__free_realized): Don't call mwin__free_realized_face.

	* draw.c (Mdepth): Don't declare it here.
	(draw_background): Call frame->driver->XXX instead of mwin__XXX.
	(render_glyphs, render_glyph_string): Likewise.
	(mdraw__init): Don't set Mdepth.
	(mdraw_text, mdraw_image_text, mdraw_text_with_control): Call
	M_CHECK_WRITABLE.
	(mdraw_text_per_char_extents): Return 0 on success and -1 on
	error.
	(mdraw_text_items): Check FRAME is writable.
	(mdraw_per_char_extents): Implement body.

	* Makefile.am (lib_LTLIBRARIES): Include libm17n-gui.la and
	libm17n-gd.la.
	(OPTIONAL_LD_FLAGS): Include @FONTCONFIG_LD_FLAGS@.
	(GUI_SOURCES): Delete it.
	(libm17n_X_la_SOURCES): Don't include ${GUI_SOURCES}.
	(libm17n_gui_la_SOURCES, libm17n_gui_la_LIBADD)
	(libm17n_gui_la_LDFLAGS, libm17n_gd_la_SOURCES)
	(libm17n_gd_la_LIBADD, libm17n_gd_la_LDFLAGS): New targets.
	(linkgui_LDADD): Set to libm17n-gui.la
	(linkgui_LDFLAGS): New target.
	(SRC): Include ${libm17n_gui_la_SOURCES} and
	${libm17n_gd_la_SOURCES}.

2004-05-24  Kenichi Handa  <handa@m17n.org>

	* draw.c (draw_background): Don't draw background even if
	rface->face.property[MFACE_BACKGROUND] is not Mnil.

2004-05-22  Kenichi Handa  <handa@m17n.org>

	* m17n-X.c (xft_open_font): Fix anti_alias setting.

2004-05-20  Kenichi Handa  <handa@m17n.org>

	* m17n-gui.h (MFaceHookFunc): Change this function type to void.

	* m17n-gui.c: Include "plist.h".
	(mframe): If PLIST is NULL, initialize it to emply plist.

	* m17n-X.c (build_font_list): Don't set property[MFONT_TYPE].
	(xft_driver): New variable.
	(xft_select, close_xft, xft_open_font, xft_open, xft_close)
	(xft_find_metric, xft_render): New function.
	(mwin__init): Adjusted for the new mfont__driver_list.
	(mwin__open_device): Assume arg PARAM is not NULL.  Push a newly
	generated face to PARAM.
	(mwin__realize_face): Fix setting of box colors.  Don't call hook
	function here.
	(mwin__draw_hline): New function.
	(mwin__xft_close, mwin__xft_open, mwin__xft_get_metric)
	(mwin__xft_render): Delete these function.

	* internal-gui.h (struct MFrame): New member tick.
	(struct MGlyphString): New member tick.
	(mwin__draw_rect, mwin__draw_empty_boxes): Extern them.
	(mwin__xft_open, mwin__xft_close, mwin__xft_get_metric)
	(mwin__xft_render): Delete extern.

	* fontset.c (mfont__lookup_fontset): Make the code simpler.
	(mfontset): Always increment the reference count of returned
	object.

	* font-ft.c (mfont__ft_fini): Don't include <otf.h> here.
	(MFTInfo): Moved to font.h.
	(ft_iso8859_1_font_list): Delete this variable.
	(set_font_info): Don't set font->property[MFONT_TYPE].
	(set_font_info): Don't udpate ft_iso8859_1_font_list.
	(add_font_info): Change type to void.
	(fc_list): Change anme from xft_list.  Caller changed.  Include
	FC_FOUNDRY and FC_PIXEL_SIZE in FcObjectSet.
	(mfont__ft_driver): Change name from ft_driver.  Caller changed.
	(ft_select): Check HAVE_FONTCONFIG instead of HAVE_XFT2.
	(close_ft): Don't call mwin__xft_close.  Unref
	ft_info->extra_info.
	(ft_open): Don't setup ft_info->fontname.  Don't call
	mwin__xft_open.
	(ft_find_metric): Don't call mwin__xft_get_metric.
	(ft_encode_char): Call rfont->driver->open instead of ft_open.
	(ft_render): Don't check HAVE_XFT2.  Don't call mwin__xft_render.
	(mfont__ft_init): Adjusted for new mfont__driver_list.
	(mfont__ft_fini): Don't unref ft_iso8859_1_font_list.

	* font.c (mfont__driver_list): Make it MPlist.
	(mfont__init): Adjust initialization of mfont__driver_list.
	(mfont__fini): Free mfont__driver_list.
	(mfont__set_spec_from_face): Don't set spec->property[MFONT_TYPE].
	(mfont__select): Adjusted for the new mfont__driver_list.

	* font.h (enum MFontProperty): Delete MFONT_TYPE.
	(mfont__drirver_list): Adjust prototype.
	(MFTInfo): Move to here from fron.c.  Deleve member fontname.

	* face.h (struct MFace): Delete member realized_face_list, add
	member frame_list.
	(struct MRealizedFace): Delete member need_update
	andnofont_rface, add member non_ascii_list.
	(mface__update_frame_face): Extern it.

	* face.c (hline_prop_list, box_prop_list, noop_hook): New
	variables.
	(get_hline_create, get_box_create): New functions.
	(find_realized_face): Cancel previous change.  Arg RFONT deleted.
	Use memcmp.
	(free_face): Cancep previous change.  Free face->frame_list.
	(serialize_hline): Do nothing if hline->width is zero.
	(serialize_box): Do nothing if box->width is zero.
	(mface__init): Setup all properties of mface__default.
	(mface__fini): Free hline_prop_list and box_prop_list.
	(mface__realize): Cancel previous change.  Update
	face->frame_list.  Setup rface->non_ascii_list.
	(mface__for_chars): Update rface->non_ascii_list.
	(mface__free_realized): Free rface->non_ascii_list.
	(mface__update_frame_face): New function.
	(mface): Initialize face->frame_list.
	(mface_copy): Likewise.  Just copy MFACE_HLINE and MFACE_BOX
	properties.
	(mface_merge): Likewise.
	(mface_put_prop): If key is Mhline or Mbox, get value by
	get_hline_create or get_box_create respectively.
	(mface_put_prop): Update frame->tick and call
	mface__update_frame_face if necessary.
	(mface_update): Do nothing if func is noop_hook.

	* draw.c (render_glyphs): If a font is not found, use
	mwin__draw_empty_boxes.
	(alloc_gstring): Initialize gstring->tick.
	(get_gstring): Check gstring->tick.

2004-05-17  Kenichi Handa  <handa@m17n.org>

	* face.c (find_realized_face): Return value changed.  If RFONT is
	NULL, avoid unnecessary checking.
	(free_face): Free face->realized_face_list.
	(mface__realize): Adjusted for the change of find_realized_face.
	If it returns a realized face that needs update, free it and
	realize a new one.  Push a new realized face to
	frame->realized_face_list instead of appending.
	(mface__for_chars): Adjusted for the change of find_realized_face.
	Short cut if the required font is in rface->ascii_rface.
	(mface_put_prop): Free old value if necessary.  Set need_update
	member of realized faces to 1.

	* face.h (struct MFace): Delete member tick, add member
	realized_face_list.
	(struct MRealizedFace): Delete member tick, add member
	need_update.

2004-05-13  Kenichi Handa  <handa@m17n.org>

	* m17n-X.c (mwin__xft_open): Destroy unnecessary patterns.

2004-05-12  Kenichi Handa  <handa@m17n.org>

	* internal-gui.h (mwin__xft_open): Arguemnt name changed.

	* m17n-X.c (mwin__xft_open): Argument changed to fontname and
	parse it XftNameParse.

	* font-ft.c (MFTInfo) [HAVE_XFT2]: New member fontname.
	(all_fonts_scaned): New variable.
	(set_font_info): FAMILY may be Mnil.
	(add_font_info): Argument changed.
	(xft_list): Call add_font_info in it.
	(ft_list): Likewise.
	(ft_select): Make it work in the case family is Mnil.
	(ft_open) [HAVE_XFT2]: Setup ft_info->fontname.
	(mfont__ft_fini): Set all_fonts_scaned to 0.

	* fontset.c (mfont__lookup_fontset): Don't repeatedly try a font
	that is failed to open.

2004-05-10  Kenichi Handa  <handa@m17n.org>

	* m17n-X.c (mwin__xft_render): Don't use anti-alias if the
	device's depth is 1 (i.e. monochrome).

	* Makefile.am (OPTIONAL_LD_FLAGS): Change the order of elements
	to work around the problem of libtool.

	* font-ft.c: Include <freetype/ftbdf.h>.
	(Municode_bmp, Municode_full, Miso10646_1, Miso8859_1): New
	variables.
	(mfont__ft_init): Initialize them.
	(ft_iso8859_1_font_list): New variable.
	(set_font_info): Detect a font containing iso8859-1 glyphs and
	register it in ft_iso8859_1_font_list.  If the font is not
	scalable, assume it as BDF or PCF font and setup SIZE and RESY
	properties of the font from its properties.
	(add_font_list): If the font is not scalable, check if it is BDF
	or PCF font.  If not, ignore it.
	(ft_select): If FAMILY is Mnil, return NULL only if the requested
	registry is not iso8859-1.
	(ft_select) [not HAVE_XFT2]: If FAMILY is Mnil, select one from
	ft_iso8859_1_font_list.
	(ft_find_metric): If the font is not scalable, assume it as BDF
	or PCF, and get a metric from its properties.
	(mfont__ft_fini): Free ft_iso8859_1_font_list.

2004-05-07  Kenichi Handa  <handa@redhat.m17n.org>

	* Makefile.am (libm17n_la_LIBADD): Include -ldl.
	(libm17n_la_LDFLAGS): Delete it.
	(noinst_PROGRAMS): Renamed from bin_PROGRAMS.
	(install-binPROGRAMS, uninstall-binPROGRAMS): Delete them.

2004-05-06  Kenichi Handa  <handa@m17n.org>

	* draw.c (compose_glyph_string): Fix previous change.

2004-04-30  Kenichi Handa  <handa@m17n.org>

	* font-ft.c (ft_list): Delete unused variable `result'.
	(ft_render): Fix for the case that bitmap.pitch < bitmap.width.

2004-04-27  Kenichi Handa  <handa@m17n.org>

	* m17n-X.c: Include config.h
	[HAVE_XFT2]: Include <X11/Xft/Xft.h>.
	(GCInfo) [HAVE_XFT2]: New member xft_color_fore, xft_color_back.
	(MWDevice) [HAVE_XFT2]: New member xft_draw.
	(FRAME_CMAP, FRAME_VISUAL): New macros.
	(free_device) [HAVE_XFT2]: Destroy device->xft_draw.
	(xfont_driver): Make it static.
	(mwin__open_device) [HAVE_XFT2]: Setup device->xft_draw.
	(mwin__realize_face) [HAVE_XFT2]: Setup info->xft_color_fore and
	info->xft_color_back.
	(MXftFontInfo) [HAVE_XFT2]: New type.
	(mwin__xft_close) [HAVE_XFT2]: New function.
	(mwin__xft_open) [HAVE_XFT2]: New function.
	(mwin__xft_get_metric) [HAVE_XFT2]: New function.
	(mwin__xft_render) [HAVE_XFT2]: New function.

	* internal-gui.h [HAVE_FREETYPE]: Include FT_FREETYPE_H.
	(mwin__xft_open, mwin__xft_close) [HAVE_FREETYPE]: New externs.
	(mwin__xft_get_metric, mwin__xft_render) [HAVE_FREETYPE]: New
	externs.

	* font.h [HAVE_FREETYPE]: Include FT_FREETYPE_H.

	* font-ft.c: Don't include FT_FREETYPE_H here.
	[HAVE_XFT2]: Include <fontconfig/fontconfig.h>.
	(fontconfig_initialized, fc_config) [HAVE_XFT2]: New variables.
	(MFTInfo): New member charmap_index.
	(MFTInfo) [HAVE_XFT2]: New member xft_info.
	(check_otf_filename): Renamed from check_filename.  Return value
	changed.
	(ft_set_property): This function deleted.
	(set_font_info): New function.
	(add_font_list): Argument changed.  Add multiple fonts.
	(xft_list) [HAVE_XFT2]: New function.
	(ft_list) [not HAVE_XFT2]: New function.
	(ft_select): Add code for Xft.
	(close_ft): Likewise.
	(ft_open): Likewise.
	(ft_find_metric): Likewise.
	(ft_encode_char): Likewise.
	(ft_render): Likewise.

	* makefile.am (OPTIONAL_LD_FLAGS): Include @XFT2_LD_FLAGS@.

2004-04-26  Kenichi Handa  <handa@m17n.org>

	* textprop.c (mtext_attach_property): Declare the return type as
	`int'.

2004-04-21  Kenichi Handa  <handa@m17n.org>

	* Makefile.am (OPTIONAL_LD_FLAGS): Include @XFT2_LD_FLAGS@

2004-04-09  Kenichi Handa  <handa@m17n.org>

	* font-flt.c (struct): New members seq_beg, seq_end, seq_from,
	seq_to.
	(load_command): Setup above members.

2004-04-05  Kenichi Handa  <handa@m17n.org>

	* m17n-X.c (xfont_encode_char): Fix checking of byte1 and byte2.

2004-03-30  Kenichi Handa  <handa@m17n.org>

	* m17n-X.c (xfont_encode_char): Return MCHAR_INVALID_CODE if code
	>= 0x10000.

	* m17n-core.h (M17NLIB_PATCH_LEVEL): Changed to 2.
	(M17NLIB_VERSION_NAME): Changed to 1.0.2.

2004-03-29  Kenichi Handa  <handa@m17n.org>

	* Version 1.0 Patch Level 2 released.

2004-03-29  Kenichi Handa  <handa@m17n.org>

	* charset.c (make_charset): Set charset->fully_loaded and
	charset->simple correctly.  Don't try to get charset->min_char and
	charset->max_char for a charset of method subset and superset.
	Don't load a mapping file here.
	(mcharset__init): Set unified_max.
	(mcharset__load_from_database): Free a working plist.

	* coding.c (mcoding__fini): Free all malloced data.

	* input-gui.c (win_create_ic): Set control.as_image for preediting
	to 0.

	* internal.h (M17N_OBJECT_REGISTER): Check the member `used' (not
	`count') to initialize the array.

	* locale.c (mlocale_set): Fix the order of M17N_OBJECT_REF and
	M17N_OBJECT_UNREF.

	* m17n-X.c (xfont_render): If rface->rfont is null, draw a
	rectangle.
	(mwin__create_window): Fix bug of setting a background pixel of a
	new window.
	(mwin__adjust_window): Clear the window before drawing.

	* m17n-core.c (mdebug__report_object): Free array->objectes if
	necessary.
	(m17n_init_core): Don't set report_header_printed to 0 here.
	Fix debugging information.
	(m17n_fini_core): Set report_header_printed to 0 here.

	* m17n-core.h (mplist_deserialize): Extern it.

	* m17n-gui.c (m17n_fini_win): Fix debugging information.

	* m17n.c (m17n_fini): Fix debugging information.

	* mtext.c (mtext__adjust_foramt): New function.

	* mtext.h (mtext__adjust_foramt): Extern it.

	* plist.c (mplist_deserialize): Renamed from mplist__deserialize.

	* plist.h (mplist__deserialize): Don't extern it.

	* symbol.c (msymbol__fini): Set freed_symbols to 0.  Set all
	elements of symbol_table to NULL.  Report about created and freed
	symbols if MDEBUG_FINI is set.

2004-03-22  Kenichi Handa  <handa@m17n.org>

	* m17n-core.c (m17n_init_core): Set merror_code to MERROR_NONE.

	* m17n.c (m17n_init): Fix the way of checking merror_code.

	* m17n-gui.c (m17n_init_win): Fix the way of checking merror_code.

2004-03-22  Kenichi Handa  <handa@m17n.org>

	* fontset.c (realize_font_group): Adjust the font size by
	mfont__resize before selecting a font.

	* font-ft.c (mfont__ft_init): Add oblique and boldoblique.

2004-03-19  Kenichi Handa  <handa@m17n.org>

	* Version 1.0 Patch Level 1 released.

2004-03-19  Kenichi Handa  <handa@m17n.org>

	* m17n-core.h (M17NLIB_PATCH_LEVEL): New macro.

	* m17n-core.c (M17NLIB_PATCH_LEVEL): Describe it.

2004-03-19  Kenichi Handa  <handa@m17n.org>

	Re-apply the changes forgotten in the released version.

	* charset.c (mcharset__load_from_database): Call
	mchar_define_charset.

	* coding.c (encode_unsupporeted_char): Put Mcoding text property.
	(mconv_encode_range): Put Mcoding text property.

2004-03-18  Kenichi Handa  <handa@m17n.org>

	* draw.c (Mdepth): New variable.
	(visual_order): Delete unused local var `pos'.
	(compose_glyph_string): Fix for the case that gstring->glyphs is
	realloced.  Stop generating glyphs at TO.  Fix handling of
	control charaters.
	(layout_glyphs): Get metrics of all glyphs in advance.  Set
	lbearing and rbearing of base of composition glyph correctly.
	Handle left-overhang glyphs correctly.
	(alloc_gstring): New arg frame.  Set gstring->anti_alias.  Caller
	changed.
	(dump_combining_code): Change the defualt off_x character to ".".
	(mdraw__init): Initialize Mdepth.

	* face.c (work_gstring): New variable
	(mface__init): Initialize work_gstring.
	(mface__fini): Free work_gstring.glyphs.
	(mface__realize): Don't handle videomode property here.  Adjusted
	for the change of mfont__get_metric.
	(mface__for_chars): Adjusted for the change of mfont__get_metric.

	* face.h (enum face_gc): Moved to m17n-X.c.

	* font.h (struct MFontDriver): Arguments of find_metric changed.
	(mfont__select): Prototype adjusted.
	(mfont__get_metric): Likewise.
	(mfont__ft_drive_otf): Likewise.
	(mfont__flt_run): Likewise.
	
	* font.c (mfont__select): New argument layouter.  If layouter is
	different in the registered font, make a new copy of realized
	font.
	(mfont__get_metric): Argument changed.  Get metrics of multiple
	glyphs.
	(mfont_find): Call mfont__select with layouter as Mnil.

	* font-flt.c (FontLayoutContext): New member rfont.
	(run_otf): Adjusted for the change of mfont__ft_drive_otf.
	(mfont__flt_run): Argument changed.  Initialize ctx.rfont.

	* font-ft.c (ft_find_metric): Arguments changed.  Get metrics of
	multiple glyphs.
	(NUM_POINTS): New macro.
	(MPointTable): New type.
	(ft_render): Use mwin__draw_points instead of mwin__draw_bitmap.
	(mfont__ft_drive_otf): New argument rfont.

	* fontset.c (realize_font_group): Adjusted for the changed of
	mfont__select.
	(check_fontset_element): This function deleted.

	* input-gui.c (adjust_window_and_draw): Locate a preedit window
	off the parent window if the preedit text is zero length.

	* internal-gui.h (struct MFrame): New members foreground,
	background, videomode, font.
	(struct MGlyphString): New member anti_alias.
	(MDrawPoint): New type.
	(mwin__draw_bitmap): Prototype deleted.
	(mwin__draw_points): Prototype added.

	* m17n-gui.h (MDrawControl): New member anti_alias.

	* m17n-gui.c (free_frame): Free frame->font.
	(mframe): Set the fontset of frame->face to the default fontset.

	* m17n-X.c (RGB_GC): New type.
	(enum gc_index): Renamed from enum face_gc.  Member names changed.
	(GCInfo): New typel
	(struct MWDevice): Members foreground and background deleted.  New
	member scratch_gc, gc_list.
	(DEFAULT_FONT, FALLBACK_FONT): New macros.
	(free_device): Free GCs in device->gc_list.
	(get_rgb_gc): New function.
	(get_gc): Renamed and argument changed from get_color.
	(get_gc_for_anti_alias): New function.
	(xfont_find_metric): Arguments changed.  Get metrics of multiple
	glyphs.
	(set_region): Argument changed.  Caller changed.
	(xfont_render): Allways set a font in gc.
	(x_error_handler, x_io_error_handler): Define only if
	X_SET_ERROR_HANDLER is defined.
	(mwin__open_device): Create device->scratch_gc.  Set members
	foreground, background, and videomode of frame.  Call
	XSetErrorHandler and XSetIOErrorHandler only if
	X_SET_ERROR_HANDLER is defined.
	(struct gc_list): Deleted.
	(REGISTER_GC, UNREGISTER_GC): These macros deleted.
	(mwin__realize_face): Adjusted for the change of the format of
	rface->info and the charge of set_region.
	(mwin__free_realized_face, mwin__fill_space, mwin__draw_hline)
	(mwin__draw_box): Likewise.
	(mwin__draw_bitmap): This function deleted.
	(mwin__draw_points): New function.
	(mwin__verify_region): Adjusted for the change of the format of
	rface->info and the charge of set_region.
	(mwin__create_window): Inherit backgound pixel from parent.
	(mwin__dump_gc): Adjusted for the change of the format of
	rface->info.

2004-03-16  Kenichi Handa  <handa@m17n.org>

	* m17n-X.c (mwin__parse_event): Fix handling of modifier keys.

	* input.c (M_key_alias): New variable.
	(handle_key): Try M_key_alias property of a key too.
	(minput__init): Initialize M_key_alias.  Give that property to
	symbols in one_char_symbol.  Fix bug of initializing
	one_char_symbol.

	* draw.c (compose_glyph_string): Don't handle
	ignore_formatting_char here.  Include formatting characters in the
	range processed by a FTL.
	(layout_glyph_string): Handle ignore_formatting_char here.

2004-03-12  Kenichi Handa  <handa@m17n.org>

	* input-gui.c (win_create_ic): Enable bidi in status control.

	* draw.c (visual_order): Avoid re-ordering of combining glyphs only.

2004-03-09  Kenichi Handa  <handa@m17n.org>

	* input.c (load_input_method): If title is not specified, use the
	input method name as title.

	* m17n-X.c (get_color): Make it static.
	(xim_create_ic, xim_destroy_ic, x_error_handler)
	(x_io_error_handler): Likewise.

2004-03-01  Kenichi Handa  <handa@m17n.org>

	* Version 1.0 released.


Copyright (C) 2003, 2004
  National Institute of Advanced Industrial Science and Technology (AIST)
  Registration Number H15PRO112

This file is part of the m17n library.

The m17n library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public License
as published by the Free Software Foundation; either version 2.1 of
the License, or (at your option) any later version.

The m17n library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with the m17n library; if not, write to the Free
Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA
02111-1307, USA.
